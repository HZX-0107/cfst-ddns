# CFST-DDNS: Cloudflare ä¼˜é€‰ IP è‡ªåŠ¨ DDNS å·¥å…·

**cfst-ddns** æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„é«˜æ€§èƒ½å·¥å…·ï¼Œå®ƒé›†æˆäº† [CloudflareSpeedTest](https://github.com/XIU2/CloudflareSpeedTest) çš„æµ‹é€Ÿèƒ½åŠ›å’Œè…¾è®¯äº‘ (DNSPod) çš„ APIã€‚

è¯¥å·¥å…·ä¼šè‡ªåŠ¨å¯»æ‰¾å½“å‰ç½‘ç»œç¯å¢ƒä¸‹é€Ÿåº¦æœ€å¿«çš„ Cloudflare IP åœ°å€ï¼Œå¹¶å°†å…¶è‡ªåŠ¨æ›´æ–°åˆ°ä½ çš„ DNSPod åŸŸåè§£æè®°å½•ä¸­ã€‚æ”¯æŒ IPv4 å’Œ IPv6ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

- **å…¨è‡ªåŠ¨æµç¨‹**ï¼šä¸€é”®è¿è¡Œï¼Œè‡ªåŠ¨å®Œæˆæµ‹é€Ÿ -> é€‰ä¼˜ -> è§£ææ›´æ–°ã€‚
- **é›¶ä¾èµ–éƒ¨ç½²**ï¼šåˆ©ç”¨ Go çš„ `embed` ç‰¹æ€§ï¼Œå¯å°† CloudflareSpeedTest äºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥æ‰“åŒ…è¿›ç¨‹åºï¼Œç”Ÿæˆå•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ— éœ€æºå¸¦çç¢çš„èµ„æºæ–‡ä»¶å¤¹ã€‚
- **åŒæ ˆæ”¯æŒ**ï¼šå®Œç¾æ”¯æŒ IPv4 (A è®°å½•) å’Œ IPv6 (AAAA è®°å½•) çš„ä¼˜é€‰ä¸æ›´æ–°ã€‚
- **æ™ºèƒ½æ›´æ–°**ï¼šè‡ªåŠ¨æ£€æµ‹ DNS è®°å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™æ›´æ–°ï¼›è‹¥ IP æ— å˜åŒ–åˆ™è·³è¿‡ï¼ŒèŠ‚çœ API è°ƒç”¨ã€‚
- **Docker æ”¯æŒ**ï¼šæä¾› Dockerfileï¼Œæ”¯æŒåŠ¨æ€ç‰ˆæœ¬æ‹‰å–æ„å»ºï¼Œè½»æ¾é›†æˆåˆ°å®¹å™¨ç¯å¢ƒã€‚
- **é…ç½®çµæ´»**ï¼šæ”¯æŒ YAML é…ç½®æ–‡ä»¶ï¼Œæ¸…æ™°ç®¡ç†å¯†é’¥å’Œæµ‹é€Ÿå‚æ•°ã€‚

## ğŸ› ï¸ å‡†å¤‡å·¥ä½œ

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä½ æ‹¥æœ‰ï¼š

1. **è…¾è®¯äº‘ API å¯†é’¥** (SecretId, SecretKey)ï¼šç”¨äºæ“ä½œ DNSPodã€‚å¦‚æœä½¿ç”¨dockeré•œåƒï¼Œé‚£ä¹ˆä¸éœ€è¦å‡†å¤‡ä»¥ä¸‹ä¸¤é¡¹
2. **CloudflareSpeedTest äºŒè¿›åˆ¶æ–‡ä»¶**ï¼š
   - **å¼€å‘æ¨¡å¼**ï¼šéœ€ä¸‹è½½å¯¹åº”çš„ `cfst` æ–‡ä»¶å¹¶è§£å‹æ”¾å…¥ `assets/` ç›®å½•ã€‚
   - **è¿è¡Œæ¨¡å¼**ï¼šå¦‚æœä½¿ç”¨é¢„ç¼–è¯‘å¥½çš„å•æ–‡ä»¶ç‰ˆæœ¬ï¼Œåˆ™æ— éœ€å‡†å¤‡æ­¤é¡¹ã€‚
3. **IP åœ°å€åº“** (`ip.txt` / `ipv6.txt`)ï¼šç”¨äºæµ‹é€Ÿçš„ IP æ®µåˆ—è¡¨ï¼ˆæ”¾å…¥ `assets/` ç›®å½•ï¼‰ã€‚ä¸€èˆ¬ä¸‹è½½çš„CloudflareSpeedTest é¡¹ç›®æ–‡ä»¶å¤¹ä¸­æœ‰

## ğŸš€ å¿«é€Ÿå¼€å§‹ (æœ¬åœ°è¿è¡Œ)

### 1. ç¼–è¯‘

```
# ç¡®ä¿ assets ç›®å½•ä¸‹æœ‰ cfst äºŒè¿›åˆ¶æ–‡ä»¶å’Œ ip.txt
# Windows ä¸‹å»ºè®®å°† cfst.exe é‡å‘½åä¸º cfst ä»¥é€‚é… embed
go build -o cfst-ddns cmd/app/main.go
```

### 2. é…ç½®

åœ¨ `configs` ç›®å½•ä¸‹åˆ›å»º `config.yaml` æ–‡ä»¶ï¼ˆå¯å‚è€ƒä¸‹æ–‡é…ç½®è¯´æ˜ï¼‰ã€‚

### 3. è¿è¡Œ

```
./cfst-ddns
```

ç¨‹åºå¯åŠ¨åä¼šè‡ªåŠ¨é‡Šæ”¾å†…éƒ¨é›†æˆçš„æµ‹é€Ÿå·¥å…·åˆ°ä¸´æ—¶ç›®å½•ï¼Œæ‰§è¡Œæµ‹é€Ÿï¼Œå¹¶æ›´æ–° DNSã€‚

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜

æ–‡ä»¶è·¯å¾„ï¼š`configs/config.yaml`

```
app:
  debug: false          # å¼€å¯åï¼Œä¼šæ‰“å°è¯¦ç»†çš„debugä¿¡æ¯ï¼Œè°ƒè¯•æ—¶å¯ä»¥ä½¿ç”¨
  # cron: "0 */1 * * *" # å®šæ—¶ä»»åŠ¡è¡¨è¾¾å¼ (é¢„ç•™åŠŸèƒ½)

tencent:
  secret_id: "ä½ çš„_SecretId"
  secret_key: "ä½ çš„_SecretKey"

domain:
  main_domain: "example.com" # ä¸»åŸŸå
  sub_domain: "cf"           # å­åŸŸå (ä¾‹å¦‚ cf.example.com)
  
# å¦‚æœä½¿ç”¨dockeré•œåƒï¼Œé‚£ä¹ˆä¸éœ€è¦é…ç½®ä¸‹é¢è·¯å¾„
speedtest:
  # æµ‹é€Ÿå·¥å…·è·¯å¾„ (å¦‚æœä½¿ç”¨ embed æ¨¡å¼ï¼Œæ­¤è·¯å¾„ä¼šè¢«ç¨‹åºè‡ªåŠ¨è¦†ç›–ä¸ºä¸´æ—¶è·¯å¾„)
  bin_path: "./assets/cfst"
  
  # IP åº“æ–‡ä»¶è·¯å¾„
  ip_file: "./assets/ip.txt"
  ipv6_file: "./assets/ipv6.txt" # å¦‚æœä¸éœ€è¦ IPv6ï¼Œå¯ç•™ç©ºæˆ–åˆ é™¤æ–‡ä»¶
  
  # ç»“æœè¾“å‡ºè·¯å¾„
  output_csv_v4: "./assets/result_v4.csv"
  output_csv_v6: "./assets/result_v6.csv"
  
  # æµ‹é€Ÿå‚æ•°
  max_ping: 9999    # æœ€å¤§å»¶è¿Ÿ (æ¯«ç§’)
  test_count: 500   # æµ‹é€Ÿæ•°é‡
```

## ğŸ³ Docker éƒ¨ç½²

æœ¬é¡¹ç›®æ”¯æŒå¤šç§ Docker éƒ¨ç½²æ–¹å¼ã€‚æ¨èä½¿ç”¨ GitHub é•œåƒç«™ (GHCR) ç›´æ¥æ‹‰å–ã€‚

### æ–¹å¼ä¸€ï¼šDocker Compose (æ¨è)

```yml
services:
  cfst-ddns:
    image: ghcr.io/hzx-0107/cfst-ddns:latest
    container_name: cfst-ddns
    # è®¾ç½®æ—¶åŒº
    environment:
      TZ: Asia/Shanghai
    volumes:
      - ./configs:/app/configs
      - ./assets:/app/assets
    # å¦‚æœç¨‹åºåªæ˜¯è¿è¡Œä¸€æ¬¡å°±é€€å‡º(Jobç±»å‹)ï¼Œä¸éœ€è¦ restart: always
    # å¦‚æœæœªæ¥å¢åŠ äº† Cron åŠŸèƒ½é•¿æœŸè¿è¡Œï¼Œå¯ä»¥å¼€å¯ restart
    restart: no 
```

å¯åŠ¨æœåŠ¡ï¼š

```shell
docker-compose up -d
```

### æ–¹å¼äºŒï¼šDocker CLI

```shell
docker run -d \
  --name cfst-ddns \
  -v $(pwd)/configs:/app/configs \
  -v $(pwd)/assets:/app/assets \
  ghcr.io/hzx-0107/cfst-ddns:latest
```

### æ–¹å¼ä¸‰ï¼šæ‰‹åŠ¨æ„å»ºé•œåƒ

```shell
# é»˜è®¤æ„å»º
docker build -t cfst-ddns .

# æŒ‡å®š CloudflareSpeedTest ç‰ˆæœ¬æ„å»º
docker build --build-arg CFST_VERSION=v2.3.4 -t cfst-ddns .
```

### è¿è¡Œå®¹å™¨

å»ºè®®æŒ‚è½½é…ç½®ç›®å½•å’Œèµ„æºç›®å½•ï¼Œä»¥ä¾¿æŒä¹…åŒ–æ•°æ®å’Œä¿®æ”¹é…ç½®ã€‚

```shell
docker run -d \
  --name cfst-ddns \
  -v $(pwd)/configs:/app/configs \
  -v $(pwd)/assets:/app/assets \
  cfst-ddns
```

**æ³¨æ„**ï¼šå®¹å™¨è¿è¡Œå®Œæ¯•åä¼šè‡ªåŠ¨é€€å‡ºï¼ˆå› ä¸ºæ˜¯å•æ¬¡ä»»åŠ¡ï¼Œå®šæ—¶åŠŸèƒ½æš‚æœªå¼€å‘å¥½ï¼‰ã€‚å¦‚æœä½ éœ€è¦å®šæ—¶è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨ç³»ç»Ÿçš„ crontab å®šæ—¶å¯åŠ¨å®¹å™¨ï¼Œæˆ–è€…ä½¿ç”¨ Kubernetes çš„ CronJobã€‚

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
cfst-ddns/
â”œâ”€â”€ assets/             # é™æ€èµ„æº (Embed ç›®æ ‡ç›®å½•)
â”‚   â”œâ”€â”€ cfst            # [å¿…éœ€] CloudflareSpeedTest äºŒè¿›åˆ¶
â”‚   â”œâ”€â”€ ip.txt          # [å¿…éœ€] IPv4 æ®µ
â”‚   â”œâ”€â”€ ipv6.txt        # [å¯é€‰] IPv6 æ®µ
â”‚   â””â”€â”€ embed.go        # Go Embed å£°æ˜æ–‡ä»¶
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ app/
â”‚       â””â”€â”€ main.go     # ç¨‹åºå…¥å£
â”œâ”€â”€ configs/            # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ config.yaml
â”œâ”€â”€ internal/           # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ config/         # é…ç½®åŠ è½½
â”‚   â”œâ”€â”€ dns/            # è…¾è®¯äº‘ SDK å°è£…
â”‚   â””â”€â”€ speedtest/      # æµ‹é€Ÿå·¥å…·è°ƒç”¨ä¸è§£æ
â”œâ”€â”€ Dockerfile          # Docker æ„å»ºæ–‡ä»¶
â””â”€â”€ go.mod              # Go ä¾èµ–ç®¡ç†
```

## âš ï¸ å…è´£å£°æ˜

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚ä½¿ç”¨ CloudflareSpeedTest è¿›è¡Œä¼˜é€‰ IP å¯èƒ½ä¼šå—é™äºç½‘ç»œç¯å¢ƒï¼Œè¯·éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„å’Œç½‘ç»œè¿è¥å•†çš„æœåŠ¡æ¡æ¬¾ã€‚

## ğŸ™ è‡´è°¢

- [XIU2/CloudflareSpeedTest](https://github.com/XIU2/CloudflareSpeedTest): å¼ºå¤§çš„ Cloudflare ä¼˜é€‰ IP å·¥å…·ã€‚
- [Tencent Cloud SDK for Go](https://github.com/tencentcloud/tencentcloud-sdk-go): è…¾è®¯äº‘å®˜æ–¹ Go SDKã€‚